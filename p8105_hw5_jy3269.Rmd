---
title: "p8105_hw5_jy3269"
author: "Jingyi Yao"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
library(tidyverse)
library(gtsummary)
set.seed(1)
```



# Problem 2

### 1. Describe the raw data
```{r}
raw_data <- read_csv("./data/homicide-data.csv",show_col_types = FALSE)

dim(raw_data)

```


```{r}
raw_data %>% 
  select(-uid) %>% 
  tbl_summary(missing_text = "(Missing)", # counts missing values
  statistic = list(all_continuous() ~ "{mean} ({sd})")) %>%  # what to do with cont
  bold_labels() %>%
  italicize_levels()

```


### 2. Create a `city_state` variable
```{r}
homicide <- raw_data %>% 
  mutate(city_state = str_c(city,", ",state)) %>% 
  select(uid,city_state,everything())

head(homicide)

```

### 3. Summarize within cities
```{r}
homicide %>% 
  group_by(city_state) %>% 
  summarize(
    total_homicides = n(),
    unsolved_homicides = sum(disposition == "Open/No arrest") + sum(disposition == "Closed without arrest")) %>% 
  arrange(desc(total_homicides)) %>% 
  knitr::kable()

```


### 4. Focus on Baltimore, MD
```{r}
baltimore <- homicide %>% 
  filter(city_state == "Baltimore, MD") %>% 
  mutate(
    unsolved_homicides = ifelse(disposition == "Open/No arrest" | disposition == "Closed without arrest", 1,0)) 

```


#### 5. Conduct proportion test and save the results
```{r}
result_baltimore <- prop.test(sum(baltimore$unsolved_homicides),length(baltimore$unsolved_homicides)) %>% 
  broom::tidy()

result_baltimore

save(result_baltimore, file = "result/results_baltimore.RData")
```


#### 6. Pull the estimated proportion and confidence intervals
```{r}
# using pull()
prop_estimate_baltimore <- result_baltimore %>% 
  pull(estimate)

lower_bound_baltimore <- result_baltimore %>% 
  pull(conf.low)

upper_bound_baltimore <- result_baltimore %>% 
  pull(conf.high)

baltimore_estimate <- list(
  "proportion_estimate" = prop_estimate_baltimore,
  "lower_CI_estimate" = lower_bound_baltimore,
  "upper_CI_estimate" = upper_bound_baltimore
) %>% 
  bind_rows()

baltimore_estimate

```


```{r}
# not using pull(), using select()
result_baltimore <- prop.test(sum(baltimore$unsolved_homicides),length(baltimore$unsolved_homicides)) %>% 
  broom::tidy() %>% 
  select(estimate,conf.low,conf.high)

result_baltimore

```


#### 7. define a function
```{r}
unsolved <- function(citystate){
  by_city <- homicide %>% 
    filter(city_state == citystate) %>% 
    mutate(unsolved_homicides = ifelse(disposition == "Open/No arrest" | disposition == "Closed without arrest", 1,0)) 
  
    result <- prop.test(sum(by_city$unsolved_homicides),length(by_city$unsolved_homicides)) %>% 
    broom::tidy() %>% 
    select(estimate, conf.low, conf.high)
    
    result
}

unsolved("Memphis, TN")
  
```


#### 8. iterate the function among each city
```{r}
cityname = unique(homicide$city_state) 

result <- expand_grid(city_state = cityname) %>% 
  mutate(prop_test_result = map(cityname, unsolved)) %>% 
  unnest(prop_test_result) %>% 
  arrange(desc(estimate))

result
```


```{r}
ggplot(result, aes(y = fct_reorder(city_state, estimate), x = estimate)) +
  geom_point()+
  geom_errorbar(aes(ymin = conf.low, ymax = conf.high))+
  labs(title = "Proportion of unsolved homocide among cities", ) + xlab("City,State")

```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```


```{r}


```